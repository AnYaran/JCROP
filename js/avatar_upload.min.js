var AVATAR_BIG_WIDTH=100;var AVATAR_BIG_HEIGHT=100;var AVATAR_SMALL_WIDTH=55;var AVATAR_SMALL_HEIGHT=55;var AVATAR_RADIO=AVATAR_BIG_WIDTH/AVATAR_BIG_HEIGHT;var jcrop_api=null;$(function(){mouseOverOut("fileImg","openImgBtn","avatar-filebtn-hover");mouseOverOut("saveAvatar","saveAvatar","avatar-savebtn-hover");mouseOverOut("fileReImg","avatarRechoicebtn","avatar-cancelbtn-hover");$(document).on("change","#fileImg,#fileReImg",function(){ajaxFileUpload()});$("#saveAvatar").on("click",function(){saveCropAvatar()})});function mouseOverOut(c,a,b){$(document).on("mouseover","#"+c,function(){$("#"+a).addClass(b)}).on("mouseout","#"+c,function(){$("#"+a).removeClass(b)})}function uploadStatus(a,b){if(a==0){$("#avatarPrompt").html(b).removeClass("avatar-hide")}else{$("#avatarPrompt").html(b).removeClass("avatar-hide").addClass("avatar-statuserror")}}function ajaxFileUpload(){$(document).ajaxStart(function(){$("#loadingSpan").removeClass("avatar-hide")}).ajaxStop(function(){$("#loadingSpan").addClass("avatar-hide")});$.ajaxFileUpload({url:"./ajax/fileupload.json",type:"POST",fileElementId:"fileImg",secureuri:false,dataType:"JSON",data:{},success:function(b,a){if(b.success){if(jcrop_api!=null){jcrop_api.destroy()}$("#crop_tmp_avatar").val(b.tmp_avatar);$("#avatarCrop").removeClass("avatar-hide");$("#previewBoxBig, #previewBoxSmall").html('<img src="tmp/'+b.tmp_avatar+'">');$("#cropImg").attr("src","tmp/"+b.tmp_avatar);$("#cropImg").Jcrop({allowSelect:false,onChange:updatePreview,onSelect:updatePreview,aspectRatio:AVATAR_RADIO,bgColor:"transparent"},function(){jcrop_api=this;var g=jcrop_api.getBounds();var d,f,c,e;if(g[0]/g[1]>AVATAR_RADIO){f=0;e=g[1];d=(g[0]-AVATAR_BIG_WIDTH*g[1]/AVATAR_BIG_HEIGHT)/2;c=g[0]-d}else{d=0;c=g[0];f=(g[1]-AVATAR_BIG_HEIGHT*g[0]/AVATAR_BIG_WIDTH)/2;e=g[1]-f}jcrop_api.setSelect([d,f,c,e]);$("#saveAvatar").removeClass("avatar-disabled").attr("disabled",false);$("#avatarRechoicebtn,#fileReImg").removeClass("avatar-hide")})}else{alert(b.description)}},error:function(b,a,c){alert("error")}})}function updatePreview(f){var g=$("#previewBoxBig img"),k=$("#previewBoxSmall img");$("#crop_x1").val(f.x);$("#crop_y1").val(f.y);$("#crop_x2").val(f.x2);$("#crop_y2").val(f.y2);$("#crop_w").val(f.w);$("#crop_h").val(f.h);if(parseInt(f.w)>0){var b=AVATAR_BIG_WIDTH/f.w;var j=AVATAR_BIG_HEIGHT/f.h;var d=AVATAR_SMALL_WIDTH/f.w;var e=AVATAR_SMALL_HEIGHT/f.h;var a=jcrop_api.getBounds();var i=a[0];var h=a[1];g.css({width:Math.round(b*i)+"px",height:Math.round(j*h)+"px",marginLeft:"-"+Math.round(b*f.x)+"px",marginTop:"-"+Math.round(j*f.y)+"px"});k.css({width:Math.round(d*i)+"px",height:Math.round(e*h)+"px",marginLeft:"-"+Math.round(d*f.x)+"px",marginTop:"-"+Math.round(e*f.y)+"px"})}}function saveCropAvatar(){if($("#crop_tmp_avatar").val()==""){uploadStatus(1,"您还没有上传头像");return false}$.ajax({type:"POST",url:"./ajax/saveavatar.json",data:$("#form_crop_avatar").serialize(),dataType:"json",success:function(a){if(a.success){$("#crop_tmp_avatar").val("");uploadStatus(0,"成功更新头像");$("#avatarCrop").addClass("avatar-hide");$("#saveAvatar").addClass("avatar-disabled");$("#saveAvatar").attr("disabled",true);$("#avatarRechoicebtn").addClass("avatar-hide");$("#fileReImg").addClass("avatar-hide");setTimeout(function(){$("#avatarPrompt").addClass("avatar-hide")},1000)}else{uploadStatus(1,a.description)}}})};